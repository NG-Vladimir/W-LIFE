<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WORSHIP — LIFE</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#080808">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3844/3844724.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #080808; color: white; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.07); backdrop-filter: blur(15px); }
        .tab-active { background: #8B5CF6; box-shadow: 0 4px 25px rgba(139, 92, 246, 0.4); border-color: rgba(255,255,255,0.2); }
        .input-field { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); outline: none; }
        .hidden { display: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .day-cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-size: 12px; font-weight: 600; position: relative; }
        .day-active { background: #8B5CF6 !important; color: white; }
        .dot { width: 4px; height: 4px; background: #8B5CF6; border-radius: 50%; position: absolute; bottom: 4px; }
        .modal-bg { background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); }
        
        /* Анимация появления новых слотов */
        .fade-in-slot { animation: slideDown 0.3s ease-out; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="pb-32">

    <div class="max-w-md mx-auto px-6 pt-10">
        <div id="view-home">
            <header class="flex items-center justify-between mb-10">
                <h1 class="text-2xl font-black tracking-tighter uppercase italic">WORSHIP<span class="text-purple-500">—</span>LIFE</h1>
                <div class="w-8 h-8 rounded-lg glass-card flex items-center justify-center">
                    <i data-lucide="music" class="w-4 h-4 text-purple-400"></i>
                </div>
            </header>

            <div class="mb-8">
                <h2 id="display-date" class="text-4xl font-black tracking-tighter italic uppercase">Дата</h2>
                <p id="display-weekday" class="text-neutral-500 text-[10px] font-black uppercase tracking-[0.3em] mt-1">День недели</p>
            </div>

            <div id="roles-list" class="space-y-3">
                </div>
        </div>

        <div id="view-plan" class="hidden">
            <h2 class="text-3xl font-black mb-6 tracking-tighter italic uppercase">Месяц</h2>
            <div class="glass-card p-5 rounded-[32px] mb-8">
                <div id="calendar-body" class="calendar-grid"></div>
            </div>
            <div class="glass-card p-6 rounded-[32px]">
                <h3 class="text-[10px] font-black uppercase tracking-widest text-neutral-500 mb-4 italic">Нагрузка команды</h3>
                <div id="stats-list" class="space-y-4 text-sm font-bold"></div>
            </div>
        </div>

        <div id="view-settings" class="hidden">
            <h2 class="text-3xl font-black mb-6 tracking-tighter italic uppercase">Состав</h2>
            <div class="glass-card p-6 rounded-[30px] mb-8">
                <input type="text" id="new-name" placeholder="Имя Фамилия" class="input-field w-full p-4 rounded-xl text-white mb-3 text-sm font-bold">
                <button onclick="addPerson()" class="w-full bg-white text-black py-4 rounded-xl font-black uppercase text-[10px] tracking-widest">Добавить</button>
            </div>
            <div id="team-list" class="space-y-2"></div>
        </div>
    </div>

    <div id="selection-modal" class="fixed inset-0 z-[100] modal-bg flex items-end hidden">
        <div class="w-full max-w-md mx-auto bg-neutral-900 rounded-t-[40px] p-8 border-t border-white/10 shadow-2xl">
            <div class="w-12 h-1.5 bg-neutral-800 rounded-full mx-auto mb-8"></div>
            <div id="modal-people-list" class="space-y-2 max-h-[50vh] overflow-y-auto pr-2"></div>
            <button onclick="assignPerson(null)" class="w-full mt-6 p-4 rounded-2xl border border-red-500/20 text-red-500 text-[10px] font-black uppercase tracking-widest active:bg-red-500/10 transition-all">Удалить участника</button>
            <button onclick="closeModal()" class="w-full mt-2 p-4 text-neutral-500 text-[10px] font-black uppercase">Отмена</button>
        </div>
    </div>

    <div class="fixed bottom-8 left-6 right-6 glass-card rounded-[32px] p-2 flex justify-around items-center z-50">
        <button onclick="switchView('home')" id="nav-home" class="p-4 text-purple-500"><i data-lucide="layout-grid"></i></button>
        <button onclick="switchView('plan')" id="nav-plan" class="p-4 text-neutral-500"><i data-lucide="calendar-days"></i></button>
        <button onclick="switchView('settings')" id="nav-settings" class="p-4 text-neutral-500"><i data-lucide="users"></i></button>
    </div>

    <script>
        // ЛОКАЛЬНОЕ ХРАНИЛИЩЕ
        let team = JSON.parse(localStorage.getItem('wl_local_team')) || [];
        let assignments = JSON.parse(localStorage.getItem('wl_local_assigns')) || {};
        let selectedDate = new Date().toISOString().split('T')[0];

        const mainRoles = ["Ведущий", "Фоно", "Барабаны", "Гитара"];
        const backVocalRoles = ["Бэк-вокал 1", "Бэк-вокал 2", "Бэк-вокал 3", "Бэк-вокал 4"];

        function switchView(view) {
            ['view-home', 'view-plan', 'view-settings'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById('view-' + view).classList.remove('hidden');
            
            ['nav-home', 'nav-plan', 'nav-settings'].forEach(n => {
                document.getElementById(n).className = `p-4 ${n === 'nav-'+view ? 'text-purple-500' : 'text-neutral-500'}`;
            });

            if(view === 'home') renderSchedule();
            if(view === 'plan') renderCalendar();
            if(view === 'settings') renderTeamBase();
            lucide.createIcons();
        }

        function renderSchedule() {
            const d = new Date(selectedDate);
            document.getElementById('display-date').innerText = d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
            document.getElementById('display-weekday').innerText = d.toLocaleDateString('ru-RU', { weekday: 'long' });
            
            const list = document.getElementById('roles-list');
            list.innerHTML = '';
            const dayData = assignments[selectedDate] || {};

            // 1. Рендерим основные роли
            mainRoles.forEach(role => list.appendChild(createRoleCard(role, dayData[role])));

            // 2. Умный рендер бэк-вокала
            let showNextBackVocal = true;
            backVocalRoles.forEach((role, index) => {
                const name = dayData[role];
                if (name || showNextBackVocal) {
                    const card = createRoleCard(role, name, true);
                    card.classList.add('fade-in-slot');
                    list.appendChild(card);
                    // Если этот слот пустой, больше слотов бэк-вокала не показываем
                    if (!name) showNextBackVocal = false;
                }
            });

            lucide.createIcons();
        }

        function createRoleCard(role, name, isBackVocal = false) {
            const card = document.createElement('div');
            card.className = `flex items-center justify-between transition-all cursor-pointer border rounded-[26px] 
                              ${isBackVocal ? 'p-3.5 px-6 opacity-90 text-sm' : 'p-5'} 
                              ${name ? 'glass-card border-purple-500/20 shadow-lg shadow-purple-500/5' : 'border-neutral-900 border-dashed opacity-30'}`;
            
            card.onclick = () => openModal(role);
            card.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-2xl flex items-center justify-center ${name ? 'bg-purple-600 text-white' : 'bg-neutral-900 text-neutral-700'}">
                        <i data-lucide="${getIcon(role)}" class="${isBackVocal ? 'w-4 h-4' : 'w-5 h-5'}"></i>
                    </div>
                    <div>
                        <p class="text-[9px] font-black text-neutral-500 uppercase tracking-widest">${role}</p>
                        <p class="font-bold ${name ? 'text-white' : 'text-neutral-800 italic'}">${name || 'Добавить...'}</p>
                    </div>
                </div>
                ${name ? '<div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>' : ''}
            `;
            return card;
        }

        // Остальная логика (Календарь, Команда)
        function renderCalendar() {
            const body = document.getElementById('calendar-body');
            body.innerHTML = '';
            for(let d=1; d<=31; d++) {
                const dateStr = `2025-01-${d.toString().padStart(2, '0')}`;
                const hasAssign = assignments[dateStr] && Object.values(assignments[dateStr]).some(v => v);
                const cell = document.createElement('div');
                cell.className = `day-cell ${selectedDate === dateStr ? 'day-active' : 'glass-card text-neutral-500'}`;
                cell.innerHTML = `<span>${d}</span>${hasAssign ? '<div class="dot"></div>' : ''}`;
                cell.onclick = () => { selectedDate = dateStr; switchView('home'); };
                body.appendChild(cell);
            }
            renderStats();
        }

        function renderStats() {
            const list = document.getElementById('stats-list');
            list.innerHTML = '';
            const counts = {};
            team.forEach(p => counts[p.name] = 0);
            Object.values(assignments).forEach(day => {
                Object.values(day).forEach(name => { if(name && counts[name] !== undefined) counts[name]++; });
            });
            Object.entries(counts).sort((a,b) => b[1]-a[1]).forEach(([n, c]) => {
                if(c > 0) list.innerHTML += `<div class="flex justify-between"><span>${n}</span><span class="text-purple-500">${c}</span></div>`;
            });
        }

        function addPerson() {
            const val = document.getElementById('new-name').value.trim();
            if(val) { team.push({name: val}); save(); document.getElementById('new-name').value = ''; renderTeamBase(); }
        }

        function renderTeamBase() {
            const list = document.getElementById('team-list');
            list.innerHTML = '';
            team.forEach(p => {
                const d = document.createElement('div');
                d.className = "p-4 glass-card rounded-2xl mb-2 flex justify-between items-center font-bold text-sm";
                d.innerHTML = `<span>${p.name}</span><button onclick="removeTeamMember('${p.name}')" class="text-neutral-700"><i data-lucide="x" class="w-4 h-4"></i></button>`;
                list.appendChild(d);
            });
            lucide.createIcons();
        }

        function removeTeamMember(name) {
            team = team.filter(p => p.name !== name);
            save();
            renderTeamBase();
        }

        let currentRoleKey = '';
        function openModal(role) {
            currentRoleKey = role;
            const list = document.getElementById('modal-people-list');
            list.innerHTML = '';
            team.forEach(p => {
                const b = document.createElement('button');
                b.className = "w-full text-left p-5 rounded-2xl bg-neutral-800/50 border border-white/5 font-bold mb-2 active:bg-purple-600";
                b.innerText = p.name;
                b.onclick = () => { assignPerson(p.name); closeModal(); };
                list.appendChild(b);
            });
            document.getElementById('selection-modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function assignPerson(name) {
            if(!assignments[selectedDate]) assignments[selectedDate] = {};
            assignments[selectedDate][currentRoleKey] = name;
            save();
            renderSchedule();
            closeModal();
        }

        function closeModal() { document.getElementById('selection-modal').classList.add('hidden'); }
        function save() { 
            localStorage.setItem('wl_local_team', JSON.stringify(team)); 
            localStorage.setItem('wl_local_assigns', JSON.stringify(assignments)); 
        }
        function getIcon(r) {
            const m = {"Ведущий":"mic","Бэк-вокал":"mic-2","Фоно":"piano","Барабаны":"drum","Гитара":"guitar"};
            return m[r.split(' ')[0]] || "music";
        }

        switchView('home');
    </script>
</body>
</html>